openapi: "3.1.0"
info:
  title: "Oppfølgingsplan API - Arbeidsgiver"
  description: |
    API for arbeidsgivere (nærmeste ledere) for å opprette og administrere oppfølgingsplaner for sykmeldte ansatte.
    
    ## Autentisering
    Alle endepunkter krever Bearer token fra TokenX med Level4 (BankID) innlogging.
    Token må være utstedt til `syfo-oppfolgingsplan-frontend`.
    
    ## Autorisasjon
    Innlogget bruker må være registrert som nærmeste leder for den sykmeldte via `narmesteLederId`.
  version: "1.0.0"
  contact:
    name: Team eSyfo
    url: https://github.com/navikt/syfo-oppfolgingsplan-backend
servers:
  - url: http://localhost:8080
    description: Lokal utvikling
  - url: https://syfo-oppfolgingsplan-backend.intern.dev.nav.no
    description: Dev-miljø
tags:
  - name: Oppfølgingsplan
    description: Operasjoner for ferdigstilte oppfølgingsplaner
  - name: Utkast
    description: Operasjoner for utkast/kladder

paths:
  /api/v1/arbeidsgiver/{narmesteLederId}/oppfolgingsplaner:
    post:
      tags:
        - Oppfølgingsplan
      summary: Opprett ny oppfølgingsplan
      description: |
        Oppretter en ny oppfølgingsplan for den sykmeldte identifisert via `narmesteLederId`.
        Eventuelt eksisterende utkast slettes automatisk når planen opprettes.
      operationId: createOppfolgingsplan
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/NarmesteLederId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOppfolgingsplanRequest'
      responses:
        '201':
          description: Oppfølgingsplan opprettet
          headers:
            Location:
              description: URL til den nye oppfølgingsplanen
              schema:
                type: string
                example: /api/v1/arbeidsgiver/123e4567-e89b-12d3-a456-426614174000/oppfolgingsplaner/987fcdeb-51a2-3bc4-d567-890123456789
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/SykmeldtNotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/v1/arbeidsgiver/{narmesteLederId}/oppfolgingsplaner/oversikt:
    get:
      tags:
        - Oppfølgingsplan
      summary: Hent oversikt over oppfølgingsplaner
      description: |
        Returnerer metadata for alle oppfølgingsplaner (utkast, aktiv plan og tidligere planer) 
        for den sykmeldte identifisert via `narmesteLederId`.
        Tiltenkt for oversiktsvisning.
      operationId: getOppfolgingsplanOversikt
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/NarmesteLederId'
      responses:
        '200':
          description: Oversikt over oppfølgingsplaner
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OppfolgingsplanOverviewResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/SykmeldtNotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/v1/arbeidsgiver/{narmesteLederId}/oppfolgingsplaner/aktiv-plan:
    get:
      tags:
        - Oppfølgingsplan
      summary: Hent aktiv oppfølgingsplan
      description: |
        Returnerer den nyeste (aktive) oppfølgingsplanen for den sykmeldte.
      operationId: getAktivOppfolgingsplan
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/NarmesteLederId'
      responses:
        '200':
          description: Aktiv oppfølgingsplan
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OppfolgingsplanResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/PlanNotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/v1/arbeidsgiver/{narmesteLederId}/oppfolgingsplaner/{uuid}:
    get:
      tags:
        - Oppfølgingsplan
      summary: Hent spesifikk oppfølgingsplan
      description: Returnerer en komplett oppfølgingsplan identifisert ved UUID.
      operationId: getOppfolgingsplanById
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/NarmesteLederId'
        - $ref: '#/components/parameters/OppfolgingsplanUuid'
      responses:
        '200':
          description: Oppfølgingsplan
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OppfolgingsplanResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/PlanNotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/v1/arbeidsgiver/{narmesteLederId}/oppfolgingsplaner/{uuid}/del-med-lege:
    post:
      tags:
        - Oppfølgingsplan
      summary: Del oppfølgingsplan med fastlege
      description: |
        Sender oppfølgingsplanen til den sykmeldtes fastlege via dialogmelding.
        Krever aktiv sykmelding. Kan bare gjøres én gang per plan.
      operationId: delOppfolgingsplanMedLege
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/NarmesteLederId'
        - $ref: '#/components/parameters/OppfolgingsplanUuid'
      responses:
        '200':
          description: Oppfølgingsplan delt med lege
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/LegeNotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/v1/arbeidsgiver/{narmesteLederId}/oppfolgingsplaner/{uuid}/del-med-veileder:
    post:
      tags:
        - Oppfølgingsplan
      summary: Del oppfølgingsplan med NAV
      description: |
        Journalfører oppfølgingsplanen og gjør den tilgjengelig for NAV-veileder.
        Krever aktiv sykmelding. Kan bare gjøres én gang per plan.
      operationId: delOppfolgingsplanMedVeileder
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/NarmesteLederId'
        - $ref: '#/components/parameters/OppfolgingsplanUuid'
      responses:
        '200':
          description: Oppfølgingsplan delt med NAV
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/PlanNotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/v1/arbeidsgiver/{narmesteLederId}/oppfolgingsplaner/{uuid}/pdf:
    get:
      tags:
        - Oppfølgingsplan
      summary: Last ned oppfølgingsplan som PDF
      description: Genererer og returnerer oppfølgingsplanen som PDF-dokument.
      operationId: getOppfolgingsplanPdf
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/NarmesteLederId'
        - $ref: '#/components/parameters/OppfolgingsplanUuid'
      responses:
        '200':
          description: PDF-dokument
          content:
            application/pdf:
              schema:
                type: string
                format: binary
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/PlanNotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/v1/arbeidsgiver/{narmesteLederId}/oppfolgingsplaner/utkast:
    get:
      tags:
        - Utkast
      summary: Hent utkast
      description: Returnerer gjeldende utkast for den sykmeldte, eller tomt utkast hvis ingen finnes.
      operationId: getUtkast
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/NarmesteLederId'
      responses:
        '200':
          description: Utkast (kan ha null-innhold hvis ingen utkast finnes)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OppfolgingsplanUtkastResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/SykmeldtNotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags:
        - Utkast
      summary: Lagre utkast
      description: |
        Lagrer eller oppdaterer utkast for den sykmeldte.
        Utkastet lagres automatisk og kan hentes igjen senere.
      operationId: saveUtkast
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/NarmesteLederId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUtkastRequest'
      responses:
        '200':
          description: Utkast lagret
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/SykmeldtNotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - Utkast
      summary: Slett utkast
      description: |
        Sletter utkastet for den sykmeldte.
        Krever at den sykmeldte har en aktiv sykmelding.
      operationId: deleteUtkast
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/NarmesteLederId'
      responses:
        '204':
          description: Utkast slettet
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/SykmeldtNotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        TokenX-token med Level4 (BankID) autentisering.
        Må være utstedt til `syfo-oppfolgingsplan-frontend`.

  parameters:
    NarmesteLederId:
      name: narmesteLederId
      in: path
      required: true
      description: Unik identifikator for nærmeste leder-relasjonen
      schema:
        type: string
        format: uuid
        example: "123e4567-e89b-12d3-a456-426614174000"

    OppfolgingsplanUuid:
      name: uuid
      in: path
      required: true
      description: Unik identifikator for oppfølgingsplanen
      schema:
        type: string
        format: uuid
        example: "987fcdeb-51a2-3bc4-d567-890123456789"

  responses:
    BadRequest:
      description: Ugyldig forespørsel
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'
          example:
            status: 400
            type: BAD_REQUEST
            message: "Invalid request format"
            timestamp: "2025-11-28T12:00:00Z"
            path: "/api/v1/arbeidsgiver/123/oppfolgingsplaner"

    Unauthorized:
      description: Manglende eller ugyldig autentisering
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'
          example:
            status: 401
            type: AUTHENTICATION_ERROR
            message: "Token is not active"
            timestamp: "2025-11-28T12:00:00Z"
            path: "/api/v1/arbeidsgiver/123/oppfolgingsplaner"

    Forbidden:
      description: Ikke tilgang til ressursen
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'
          example:
            status: 403
            type: AUTHORIZATION_ERROR
            message: "Caller is not authorized for this endpoint"
            timestamp: "2025-11-28T12:00:00Z"
            path: "/api/v1/arbeidsgiver/123/oppfolgingsplaner"

    SykmeldtNotFound:
      description: Sykmeldt ikke funnet for gitt narmesteLederId
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'
          example:
            status: 404
            type: SYKMELDT_NOT_FOUND
            message: "Sykmeldt not found for narmestelederId: 123"
            timestamp: "2025-11-28T12:00:00Z"
            path: "/api/v1/arbeidsgiver/123/oppfolgingsplaner"

    PlanNotFound:
      description: Oppfølgingsplan ikke funnet
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'
          example:
            status: 404
            type: PLAN_NOT_FOUND
            message: "Oppfolgingsplan not found for uuid: 987fcdeb-51a2-3bc4-d567-890123456789"
            timestamp: "2025-11-28T12:00:00Z"
            path: "/api/v1/arbeidsgiver/123/oppfolgingsplaner/987fcdeb-51a2-3bc4-d567-890123456789"

    LegeNotFound:
      description: Kunne ikke finne fastlege eller partnerinformasjon
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'
          example:
            status: 404
            type: LEGE_NOT_FOUND
            message: "Unable to determine fastlege, or lacking appropriate 'partnerinformasjon'-data"
            timestamp: "2025-11-28T12:00:00Z"
            path: "/api/v1/arbeidsgiver/123/oppfolgingsplaner/456/del-med-lege"

    Conflict:
      description: Konflikt - handlingen er allerede utført
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'
          example:
            status: 409
            type: CONFLICT
            message: "Oppfolgingsplan is already shared with Veileder"
            timestamp: "2025-11-28T12:00:00Z"
            path: "/api/v1/arbeidsgiver/123/oppfolgingsplaner/456/del-med-veileder"

    InternalServerError:
      description: Intern serverfeil
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'
          example:
            status: 500
            type: INTERNAL_SERVER_ERROR
            message: "An unexpected error occurred"
            timestamp: "2025-11-28T12:00:00Z"
            path: "/api/v1/arbeidsgiver/123/oppfolgingsplaner"

  schemas:
    ApiError:
      type: object
      required:
        - status
        - type
        - message
        - timestamp
      properties:
        status:
          type: integer
          description: HTTP status code
          example: 400
        type:
          type: string
          enum:
            - AUTHENTICATION_ERROR
            - AUTHORIZATION_ERROR
            - NOT_FOUND
            - INTERNAL_SERVER_ERROR
            - ILLEGAL_ARGUMENT
            - BAD_REQUEST
            - LEGE_NOT_FOUND
            - PLAN_NOT_FOUND
            - SYKMELDT_NOT_FOUND
            - CONFLICT
          description: Feiltype for maskinell håndtering
        message:
          type: string
          description: Beskrivende feilmelding
        timestamp:
          type: string
          format: date-time
          description: Tidspunkt feilen oppstod
        path:
          type: string
          nullable: true
          description: URL-path som forårsaket feilen

    CreateOppfolgingsplanRequest:
      type: object
      required:
        - content
        - evalueringsdato
      properties:
        content:
          $ref: '#/components/schemas/FormSnapshot'
        evalueringsdato:
          type: string
          format: date
          description: Dato for evaluering av oppfølgingsplanen
          example: "2025-12-28"

    CreateUtkastRequest:
      type: object
      required:
        - content
      properties:
        content:
          type: object
          additionalProperties:
            type: string
            nullable: true
          description: Nøkkel-verdi par der nøkler er felt-identifikatorer og verdier er strenger eller null
          example:
            typiskArbeidshverdag: "Beskrivelse av arbeidsdag"
            arbeidsoppgaverSomKanUtfores: "Oppgaver som kan utføres"
            evalueringsDato: "2025-12-28"

    OppfolgingsplanOverviewResponse:
      type: object
      required:
        - userHasEditAccess
        - organization
        - employee
        - oversikt
      properties:
        userHasEditAccess:
          type: boolean
          description: Om bruker har tilgang til å redigere (krever aktiv sykmelding)
        organization:
          $ref: '#/components/schemas/OrganizationDetails'
        employee:
          $ref: '#/components/schemas/EmployeeDetails'
        oversikt:
          $ref: '#/components/schemas/OversiktResponseData'

    OversiktResponseData:
      type: object
      required:
        - tidligerePlaner
      properties:
        utkast:
          $ref: '#/components/schemas/UtkastMetadata'
          nullable: true
        aktivPlan:
          $ref: '#/components/schemas/OppfolgingsplanMetadata'
          nullable: true
        tidligerePlaner:
          type: array
          items:
            $ref: '#/components/schemas/OppfolgingsplanMetadata'

    OppfolgingsplanResponse:
      type: object
      required:
        - userHasEditAccess
        - organization
        - employee
        - oppfolgingsplan
      properties:
        userHasEditAccess:
          type: boolean
          description: Om bruker har tilgang til å redigere (krever aktiv sykmelding)
        organization:
          $ref: '#/components/schemas/OrganizationDetails'
        employee:
          $ref: '#/components/schemas/EmployeeDetails'
        oppfolgingsplan:
          $ref: '#/components/schemas/OppfolgingsplanResponseData'

    OppfolgingsplanResponseData:
      type: object
      required:
        - id
        - content
        - evalueringsDato
        - ferdigstiltTidspunkt
      properties:
        id:
          type: string
          format: uuid
        content:
          $ref: '#/components/schemas/FormSnapshot'
        evalueringsDato:
          type: string
          format: date
        deltMedLegeTidspunkt:
          type: string
          format: date-time
          nullable: true
        deltMedVeilederTidspunkt:
          type: string
          format: date-time
          nullable: true
        ferdigstiltTidspunkt:
          type: string
          format: date-time

    OppfolgingsplanUtkastResponse:
      type: object
      required:
        - userHasEditAccess
        - organization
        - employee
      properties:
        userHasEditAccess:
          type: boolean
        organization:
          $ref: '#/components/schemas/OrganizationDetails'
        employee:
          $ref: '#/components/schemas/EmployeeDetails'
        utkast:
          $ref: '#/components/schemas/UtkastResponseData'
          nullable: true

    UtkastResponseData:
      type: object
      required:
        - content
        - sistLagretTidspunkt
      properties:
        content:
          type: object
          additionalProperties:
            type: string
            nullable: true
        sistLagretTidspunkt:
          type: string
          format: date-time

    OppfolgingsplanMetadata:
      type: object
      required:
        - id
        - evalueringsDato
        - ferdigstiltTidspunkt
      properties:
        id:
          type: string
          format: uuid
        evalueringsDato:
          type: string
          format: date
        deltMedLegeTidspunkt:
          type: string
          format: date-time
          nullable: true
        deltMedVeilederTidspunkt:
          type: string
          format: date-time
          nullable: true
        ferdigstiltTidspunkt:
          type: string
          format: date-time

    UtkastMetadata:
      type: object
      required:
        - sistLagretTidspunkt
      properties:
        sistLagretTidspunkt:
          type: string
          format: date-time

    OrganizationDetails:
      type: object
      required:
        - orgNumber
      properties:
        orgNumber:
          type: string
          description: Organisasjonsnummer (9 siffer)
          example: "123456789"
        orgName:
          type: string
          nullable: true
          description: Navn på organisasjonen
          example: "Bedrift AS"

    EmployeeDetails:
      type: object
      required:
        - fnr
        - name
      properties:
        fnr:
          type: string
          description: Fødselsnummer (11 siffer)
          example: "12345678901"
        name:
          type: string
          description: Fullt navn
          example: "Ola Nordmann"

    FormSnapshot:
      type: object
      required:
        - formIdentifier
        - formSemanticVersion
        - formSnapshotVersion
        - sections
      properties:
        formIdentifier:
          type: string
          description: Identifikator for skjematypen
          example: "oppfolgingsplan"
        formSemanticVersion:
          type: string
          description: Semantisk versjon av skjemaet
          example: "1.0.0"
        formSnapshotVersion:
          type: string
          description: Versjon av snapshot-formatet
          example: "2.0.0"
        sections:
          type: array
          items:
            $ref: '#/components/schemas/Section'

    Section:
      type: object
      required:
        - sectionId
        - sectionTitle
        - fields
      properties:
        sectionId:
          type: string
          example: "arbeidsoppgaver"
        sectionTitle:
          type: string
          example: "Arbeidsoppgaver"
        fields:
          type: array
          items:
            $ref: '#/components/schemas/FieldSnapshot'

    FieldSnapshot:
      type: object
      discriminator:
        propertyName: fieldType
        mapping:
          TEXT: '#/components/schemas/TextFieldSnapshot'
          RADIO_GROUP: '#/components/schemas/RadioGroupFieldSnapshot'
          CHECKBOX_GROUP: '#/components/schemas/CheckboxGroupFieldSnapshot'
          CHECKBOX_SINGLE: '#/components/schemas/SingleCheckboxFieldSnapshot'
          DATE: '#/components/schemas/DateFieldSnapshot'
      required:
        - fieldId
        - fieldType
        - label
      properties:
        fieldId:
          type: string
        fieldType:
          type: string
          enum:
            - TEXT
            - RADIO_GROUP
            - CHECKBOX_GROUP
            - CHECKBOX_SINGLE
            - DATE
        label:
          type: string
        description:
          type: string
          nullable: true

    TextFieldSnapshot:
      allOf:
        - $ref: '#/components/schemas/FieldSnapshot'
        - type: object
          required:
            - value
          properties:
            value:
              type: string
            wasRequired:
              type: boolean
              default: true

    RadioGroupFieldSnapshot:
      allOf:
        - $ref: '#/components/schemas/FieldSnapshot'
        - type: object
          required:
            - options
          properties:
            options:
              type: array
              items:
                $ref: '#/components/schemas/RadioGroupFieldOption'
            selectedOptionId:
              type: string
              nullable: true
            wasRequired:
              type: boolean
              default: true

    RadioGroupFieldOption:
      type: object
      required:
        - optionId
        - optionLabel
      properties:
        optionId:
          type: string
        optionLabel:
          type: string

    CheckboxGroupFieldSnapshot:
      allOf:
        - $ref: '#/components/schemas/FieldSnapshot'
        - type: object
          required:
            - options
          properties:
            options:
              type: array
              items:
                $ref: '#/components/schemas/CheckboxGroupFieldOption'
            wasRequired:
              type: boolean
              default: true

    CheckboxGroupFieldOption:
      type: object
      required:
        - optionId
        - optionLabel
      properties:
        optionId:
          type: string
        optionLabel:
          type: string
        wasSelected:
          type: boolean
          default: false

    SingleCheckboxFieldSnapshot:
      allOf:
        - $ref: '#/components/schemas/FieldSnapshot'
        - type: object
          required:
            - value
          properties:
            value:
              type: boolean

    DateFieldSnapshot:
      allOf:
        - $ref: '#/components/schemas/FieldSnapshot'
        - type: object
          properties:
            value:
              type: string
              format: date
              nullable: true
            wasRequired:
              type: boolean
              default: true
